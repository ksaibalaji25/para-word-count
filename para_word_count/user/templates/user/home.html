{% extends "user/index.html" %}
{% load static %}

{% block start %}

<div class="container">
  
  <div id="message-box"></div>
  
  <div id="loading-bar" style="display: none; margin-bottom: 20px;">
    <p style="font-size: 14px;">Processing...</p>
    <div class="progress-bar-container">
      <div id="progress"></div>
    </div>
  </div>

  <!-- Save Paragraph Section -->
  <div class="form-section">
    <h2>Submit Paragraph</h2>
    
    <form id="paragraph-form">
      {% csrf_token %}
      <div style="margin-bottom: 15px;">
        <label for="raw-text">Paragraph:</label>
        <textarea id="raw-text" name="raw_text" placeholder="Paste your paragraph here..."></textarea>
      </div>
      <button type="submit">Save Paragraph</button>
    </form>
  </div>

  <!-- Search Section -->
  <div class="form-section">
    <h2>Search Word</h2>
    
    <form id="search-form">
      {% csrf_token %}
      <div class="search-flex">
        <input type="text" id="search-word" name="word" placeholder="Enter a word to search...">
        <button type="submit">Search</button>
      </div>
    </form>
  </div>

  <!-- Results Section -->
  <div id="results-section">
    <h2>Search Results</h2>
    <div id="results-container"></div>
  </div>

</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

const csrftoken = getCookie('csrftoken');

function showMessage(message, type) {
  const messageBox = document.getElementById('message-box');
  messageBox.innerHTML = '';
  const div = document.createElement('div');
  div.className = 'message ' + type;
  div.textContent = message;
  messageBox.appendChild(div);
  
  setTimeout(() => {
    messageBox.innerHTML = '';
  }, 5000);
}

function showLoadingBar() {
  document.getElementById('loading-bar').style.display = 'block';
  animateProgress();
}

function hideLoadingBar() {
  document.getElementById('loading-bar').style.display = 'none';
  document.getElementById('progress').style.width = '0%';
}

function animateProgress() {
  let width = 0;
  const interval = setInterval(() => {
    if (width < 90) {
      width += Math.random() * 30;
      document.getElementById('progress').style.width = width + '%';
    } else {
      clearInterval(interval);
    }
  }, 200);
}

// Save Paragraph
document.getElementById('paragraph-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const rawText = document.getElementById('raw-text').value.trim();
  
  if (!rawText) {
    showMessage('Please enter a paragraph', 'error');
    return;
  }
  
  showLoadingBar();
  
  try {
    const response = await fetch('/user/api/save-paragraph/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
      },
      body: JSON.stringify({ raw_text: rawText })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      const count = data.paragraphs_created || 1;
      showMessage(`✓ Successfully saved and processed ${count} paragraph(s)!`, 'success');
      document.getElementById('raw-text').value = '';
      document.getElementById('results-section').style.display = 'none';
    } else {
      showMessage('Error: ' + (data.message || 'Failed to save'), 'error');
    }
  } catch (error) {
    showMessage('Network error: ' + error.message, 'error');
  } finally {
    hideLoadingBar();
  }
});

// Search Word
document.getElementById('search-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const word = document.getElementById('search-word').value.trim();
  
  if (!word) {
    showMessage('Please enter a word to search', 'error');
    return;
  }
  
  showLoadingBar();
  
  try {
    const response = await fetch(`/user/api/search-word/?word=${encodeURIComponent(word)}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
      }
    });
    
    const data = await response.json();
    
    if (response.ok) {
      displayResults(data);
      showMessage(`✓ Found ${data.results_count} paragraphs containing "${word}"`, 'success');
    } else {
      showMessage('Error: ' + (data.message || 'Search failed'), 'error');
    }
  } catch (error) {
    showMessage('Network error: ' + error.message, 'error');
  } finally {
    hideLoadingBar();
  }
});

function displayResults(data) {
  const resultsSection = document.getElementById('results-section');
  const resultsContainer = document.getElementById('results-container');
  
  if (data.results.length === 0) {
    resultsContainer.innerHTML = '<p style="color: #999;">No results found.</p>';
    resultsSection.style.display = 'block';
    return;
  }
  
  let html = '';
  data.results.forEach((result, index) => {
    html += `
      <div class="result-item">
        <div class="result-header">
          <strong>#${index + 1} - ${result.user_name}</strong>
          <span class="result-count">Count: ${result.word_count}</span>
        </div>
        <p class="result-text">${escapeHtml(result.raw_text)}${result.raw_text.length > 500 ? '...' : ''}</p>
        <small class="result-date">Posted: ${new Date(result.created_at).toLocaleString()}</small>
      </div>
    `;
  });
  
  resultsContainer.innerHTML = html;
  resultsSection.style.display = 'block';
  resultsSection.scrollIntoView({ behavior: 'smooth' });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>

{% endblock %}
